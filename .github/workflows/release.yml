name: Create Release

on:
  push:
    tags:
      - 'v*' # è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€ä»¥ 'v' é–‹é ­çš„ tag æ™‚ï¼ˆå¦‚ v1.0.0, v0.1.1ï¼‰
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      tag_name:
        description: 'è¦ç™¼ä½ˆçš„ tag åç¨± (ä¾‹å¦‚: v0.3.4)'
        required: true
        type: string
      publish_chrome:
        description: 'ç™¼ä½ˆåˆ° Chrome Web Store'
        required: false
        type: boolean
        default: false
      publish_firefox:
        description: 'ç™¼ä½ˆåˆ° Firefox Add-ons'
        required: false
        type: boolean
        default: false
      publish_edge:
        description: 'ç™¼ä½ˆåˆ° Edge Add-ons'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}

    steps:
    - name: Get tag name
      id: tag
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.tag.outputs.tag_name }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Create extension packages for different browsers
      run: |
        # å‰µå»ºè‡¨æ™‚ç›®éŒ„
        mkdir -p chrome-build firefox-build

        # è¤‡è£½å…±ç”¨æª”æ¡ˆåˆ°å…©å€‹ç›®éŒ„
        for dir in chrome-build firefox-build; do
          cp background.js popup.html popup.js README.md $dir/
          cp -r icons _locales $dir/
        done

        # Firefox ç‰ˆæœ¬ç›´æ¥è¤‡è£½åŸå§‹çš„ manifest (Manifest V2)
        cp manifest.json firefox-build/manifest.json

        # å‰µå»º Chrome/Edge ç‰ˆæœ¬çš„ manifest (Manifest V3)
        # 1. ä¿®æ”¹ manifest_version ç‚º 3
        # 2. å°‡ browser_action æ”¹ç‚º action
        # 3. å°‡ background.scripts æ”¹ç‚º background.service_worker
        # 4. å¾ permissions ç§»é™¤ host_permissions,å–®ç¨æ”¾åœ¨ host_permissions æ¬„ä½
        # 5. ä¿®æ”¹ content_security_policy æ ¼å¼ç‚º V3 çš„ç‰©ä»¶æ ¼å¼
        # 6. ç§»é™¤ browser_specific_settings (Chrome ä¸éœ€è¦)
        jq '.manifest_version = 3 |
            .action = .browser_action |
            del(.browser_action) |
            .background = {service_worker: .background.scripts[0]} |
            .host_permissions = [.permissions[] | select(startswith("*://"))] |
            .permissions = [.permissions[] | select(startswith("*://") | not)] |
            .content_security_policy = {extension_pages: .content_security_policy} |
            del(.browser_specific_settings)' \
        manifest.json > chrome-build/manifest.json

        # æ‰“åŒ… Chrome/Edge ç‰ˆæœ¬
        cd chrome-build
        zip -r ../fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip *
        cd ..

        # æ‰“åŒ… Firefox ç‰ˆæœ¬
        cd firefox-build
        zip -r ../fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip *
        cd ..

        # åˆ—å‡ºå…©å€‹å£“ç¸®æª”å…§å®¹ä»¥ä¾›ç¢ºèª
        echo "Chrome/Edge ç‰ˆæœ¬å…§å®¹ï¼š"
        unzip -l fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip
        echo ""
        echo "Firefox ç‰ˆæœ¬å…§å®¹ï¼š"
        unzip -l fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip

        # é¡¯ç¤ºå…©å€‹ç‰ˆæœ¬çš„ manifest å·®ç•°
        echo ""
        echo "Chrome manifest:"
        unzip -p fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip manifest.json | jq .
        echo ""
        echo "Firefox manifest:"
        unzip -p fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip manifest.json | jq .

    - name: Upload Chrome package artifact
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension-${{ steps.tag.outputs.tag_name }}
        path: fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip
        retention-days: 7  # Keep artifacts for 7 days

    - name: Upload Firefox package artifact
      uses: actions/upload-artifact@v4
      with:
        name: firefox-extension-${{ steps.tag.outputs.tag_name }}
        path: fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip
        retention-days: 7  # Keep artifacts for 7 days

  # ç™¼ä½ˆåˆ° GitHub Release
  release:
    needs: build
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨ tag push æ™‚æ‰è‡ªå‹•å‰µå»º GitHub Release
    if: ${{ github.event_name == 'push' }}
    permissions:
      contents: write

    steps:
    - name: Download Chrome artifact
      uses: actions/download-artifact@v4
      with:
        name: chrome-extension-${{ needs.build.outputs.tag_name }}

    - name: Download Firefox artifact
      uses: actions/download-artifact@v4
      with:
        name: firefox-extension-${{ needs.build.outputs.tag_name }}

    - name: Create Release using gh CLI
      run: |
        # ä½¿ç”¨ gh CLI å‰µå»º releaseï¼ˆè‰ç¨¿æ¨¡å¼ï¼Œè‡ªå‹•ç”¢ç”Ÿ release notesï¼‰
        gh release create ${{ needs.build.outputs.tag_name }} \
          --repo ${{ github.repository }} \
          --title "FB Post URL Unhash ${{ needs.build.outputs.tag_name }}" \
          --notes-file <(cat << 'EOF'
        ## FB Post URL Unhash - ${{ needs.build.outputs.tag_name }}

        Facebook æ–‡ç« ç¶²å€è½‰æ›å™¨ - å°‡åŒ…å« pfbid çš„ Facebook æ–‡ç«  URL è½‰æ›æˆå¯æå–æ•¸å­— ID çš„æ ¼å¼ã€‚

        ### ğŸ“¦ å®‰è£æ–¹å¼
        1. æ ¹æ“šæ‚¨çš„ç€è¦½å™¨ä¸‹è¼‰å°æ‡‰çš„æª”æ¡ˆï¼š
           - **Chrome/Edge**: `fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-chrome.zip` (Manifest V3)
           - **Firefox**: `fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-firefox.zip` (Manifest V2)
        2. è§£å£“ç¸®åˆ°ä»»æ„ç›®éŒ„
        3. åœ¨ç€è¦½å™¨ä¸­è¼‰å…¥è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾ä½œç‚ºæ“´å……åŠŸèƒ½

        ### ğŸ¦Š Firefox å®‰è£ï¼š
        - å‰å¾€ `about:debugging`
        - é»æ“Šã€ŒThis Firefoxã€
        - é»æ“Šã€ŒLoad Temporary Add-onã€
        - é¸æ“‡è§£å£“ç¸®è³‡æ–™å¤¾ä¸­çš„ `manifest.json`

        ### ğŸ” Chrome/Edge å®‰è£ï¼š
        - å‰å¾€ `chrome://extensions/` æˆ– `edge://extensions/`
        - é–‹å•Ÿã€Œé–‹ç™¼äººå“¡æ¨¡å¼ã€
        - é»æ“Šã€Œè¼‰å…¥æœªå°è£é …ç›®ã€
        - é¸æ“‡è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾

        ### âœ¨ ä¸»è¦åŠŸèƒ½
        - âœ… è·¨ç€è¦½å™¨ç›¸å®¹ï¼ˆChromeã€Edgeã€Firefoxï¼‰
        - âœ… å½ˆå‡ºè¦–çª—ç›´æ¥é¡¯ç¤ºåµŒå…¥çš„ Facebook æ–‡ç« 
        - âœ… å³éµé¸å–®å¿«é€Ÿé–‹å•ŸåµŒå…¥é é¢
        - âœ… è‡ªå‹•åµæ¸¬ Facebook æ–‡ç«  URL æ ¼å¼

        EOF
        ) \
          --draft \
          --generate-notes \
          fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-chrome.zip \
          fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-firefox.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç™¼ä½ˆåˆ° Chrome Web Store
  publish-chrome:
    needs: build
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æ‰‹å‹•è§¸ç™¼ä¸”å‹¾é¸ç™¼ä½ˆåˆ° Chrome æ™‚æ‰åŸ·è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_chrome }}

    steps:
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Download Chrome artifact
      uses: actions/download-artifact@v4
      with:
        name: chrome-extension-${{ needs.build.outputs.tag_name }}

    - name: Get Access Token and Upload to Chrome Web Store
      run: |
        # ä½¿ç”¨ refresh token å–å¾— access token
        TOKEN_RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
          -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
          -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
          -d "grant_type=refresh_token")

        ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')

        if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "Failed to get access token"
          echo "$TOKEN_RESPONSE"
          exit 1
        fi

        echo "Successfully obtained access token"

        # ä¸Šå‚³æ“´å……åŠŸèƒ½å¥—ä»¶
        UPLOAD_RESPONSE=$(curl -s -X PUT \
          "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "x-goog-api-version: 2" \
          -H "Content-Type: application/zip" \
          --data-binary @fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-chrome.zip)

        echo "Upload response: $UPLOAD_RESPONSE"

        UPLOAD_STATE=$(echo "$UPLOAD_RESPONSE" | jq -r '.uploadState')

        if [ "$UPLOAD_STATE" != "SUCCESS" ]; then
          echo "Failed to upload package"
          echo "$UPLOAD_RESPONSE" | jq .
          exit 1
        fi

        echo "Package uploaded successfully"

        # ç™¼ä½ˆæ“´å……åŠŸèƒ½
        PUBLISH_RESPONSE=$(curl -s -X POST \
          "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}/publish" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "x-goog-api-version: 2" \
          -H "Content-Length: 0")

        echo "Publish response: $PUBLISH_RESPONSE"

        PUBLISH_STATUS=$(echo "$PUBLISH_RESPONSE" | jq -r '.status[0]')

        if [ "$PUBLISH_STATUS" != "OK" ] && [ "$PUBLISH_STATUS" != "PENDING" ]; then
          echo "Failed to publish extension"
          echo "$PUBLISH_RESPONSE" | jq .
          exit 1
        fi

        echo "Extension published successfully (status: $PUBLISH_STATUS)"

  # ç™¼ä½ˆåˆ° Firefox Add-ons (AMO)
  publish-firefox:
    needs: build
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æ‰‹å‹•è§¸ç™¼ä¸”å‹¾é¸ç™¼ä½ˆåˆ° Firefox æ™‚æ‰åŸ·è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_firefox }}

    steps:
    - name: Download Firefox artifact
      uses: actions/download-artifact@v4
      with:
        name: firefox-extension-${{ needs.build.outputs.tag_name }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install web-ext
      run: npm install -g web-ext

    - name: Upload to Firefox Add-ons
      run: |
        # è§£å£“ç¸®ä»¥ä¾¿ä½¿ç”¨ web-ext ç°½ç½²ä¸¦æäº¤
        mkdir -p extension
        unzip fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-firefox.zip -d extension

        # ä½¿ç”¨ web-ext sign æäº¤åˆ° AMO
        # --channel=listed è¡¨ç¤ºç™¼ä½ˆåˆ°å…¬é–‹å•†åº—
        cd extension
        web-ext sign \
          --channel=listed \
          --api-key=${{ secrets.FIREFOX_JWT_ISSUER }} \
          --api-secret=${{ secrets.FIREFOX_JWT_SECRET }}

  # ç™¼ä½ˆåˆ° Microsoft Edge Add-ons
  publish-edge:
    needs: build
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æ‰‹å‹•è§¸ç™¼ä¸”å‹¾é¸ç™¼ä½ˆåˆ° Edge æ™‚æ‰åŸ·è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_edge }}

    steps:
    - name: Download Chrome artifact (Edge ä½¿ç”¨ç›¸åŒçš„ Manifest V3 åŒ…)
      uses: actions/download-artifact@v4
      with:
        name: chrome-extension-${{ needs.build.outputs.tag_name }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Get Access Token and Upload to Edge Add-ons
      run: |
        # å–å¾— Access Token
        ACCESS_TOKEN=$(curl -s -X POST "${{ secrets.EDGE_ACCESS_TOKEN_URL }}" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=${{ secrets.EDGE_CLIENT_ID }}" \
          -d "scope=https://api.addons.microsoftedge.microsoft.com/.default" \
          -d "client_secret=${{ secrets.EDGE_CLIENT_SECRET }}" \
          -d "grant_type=client_credentials" | jq -r '.access_token')

        if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "Failed to get access token"
          exit 1
        fi

        echo "Successfully obtained access token"

        # ä¸Šå‚³æ–°ç‰ˆæœ¬
        UPLOAD_RESPONSE=$(curl -s -X POST \
          "https://api.addons.microsoftedge.microsoft.com/v1/products/${{ secrets.EDGE_PRODUCT_ID }}/submissions/draft/package" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/zip" \
          --data-binary @fb-post-url-unhash-${{ needs.build.outputs.tag_name }}-chrome.zip)

        echo "Upload response status: $(echo "$UPLOAD_RESPONSE" | jq -r '.status // "unknown"')"

        OPERATION_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.id // empty')

        if [ -z "$OPERATION_ID" ]; then
          echo "Failed to upload package"
          exit 1
        fi

        echo "Package uploaded, operation ID: $OPERATION_ID"

        # ç­‰å¾…ä¸Šå‚³è™•ç†å®Œæˆ
        for i in {1..30}; do
          sleep 10
          STATUS_RESPONSE=$(curl -s -X GET \
            "https://api.addons.microsoftedge.microsoft.com/v1/products/${{ secrets.EDGE_PRODUCT_ID }}/submissions/draft/package/operations/$OPERATION_ID" \
            -H "Authorization: Bearer $ACCESS_TOKEN")

          STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
          echo "Upload status: $STATUS"

          if [ "$STATUS" == "Succeeded" ]; then
            echo "Package upload succeeded"
            break
          elif [ "$STATUS" == "Failed" ]; then
            echo "Package upload failed"
            echo "Error details: $(echo "$STATUS_RESPONSE" | jq -r '.message // .error // "Unknown error"')"
            exit 1
          fi
        done

        # æª¢æŸ¥æ˜¯å¦è¶…æ™‚
        if [ "$STATUS" != "Succeeded" ]; then
          echo "Timeout: Package upload did not complete within 5 minutes"
          exit 1
        fi

        # ç™¼ä½ˆæäº¤
        PUBLISH_RESPONSE=$(curl -s -X POST \
          "https://api.addons.microsoftedge.microsoft.com/v1/products/${{ secrets.EDGE_PRODUCT_ID }}/submissions" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{}')

        echo "Publish response status: $(echo "$PUBLISH_RESPONSE" | jq -r '.status // "unknown"')"

        PUBLISH_ID=$(echo "$PUBLISH_RESPONSE" | jq -r '.id // empty')

        if [ -z "$PUBLISH_ID" ]; then
          echo "Failed to create submission"
          exit 1
        fi

        echo "Submission created successfully, ID: $PUBLISH_ID"
