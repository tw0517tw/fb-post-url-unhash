name: Create Release

on:
  push:
    tags:
      - 'v*' # è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€ä»¥ 'v' é–‹é ­çš„ tag æ™‚ï¼ˆå¦‚ v1.0.0, v0.1.1ï¼‰

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write # éœ€è¦å¯«å…¥æ¬Šé™ä¾†å‰µå»º release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get tag name
      id: tag
      run: echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Create extension packages for different browsers
      run: |
        # å‰µå»ºè‡¨æ™‚ç›®éŒ„
        mkdir -p chrome-build firefox-build

        # è¤‡è£½å…±ç”¨æª”æ¡ˆåˆ°å…©å€‹ç›®éŒ„
        for dir in chrome-build firefox-build; do
          cp background.js popup.html popup.js README.md $dir/
          cp -r icons $dir/
        done

        # å‰µå»º Chrome/Edge ç‰ˆæœ¬çš„ manifest (åªä¿ç•™ service_worker)
        jq 'del(.background.scripts)' manifest.json > chrome-build/manifest.json

        # å‰µå»º Firefox ç‰ˆæœ¬çš„ manifest (ç§»é™¤ service_worker)
        jq 'del(.background.service_worker)' manifest.json > firefox-build/manifest.json

        # æ‰“åŒ… Chrome/Edge ç‰ˆæœ¬
        cd chrome-build
        zip -r ../fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip *
        cd ..

        # æ‰“åŒ… Firefox ç‰ˆæœ¬
        cd firefox-build
        zip -r ../fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip *
        cd ..

        # åˆ—å‡ºå…©å€‹å£“ç¸®æª”å…§å®¹ä»¥ä¾›ç¢ºèª
        echo "Chrome/Edge ç‰ˆæœ¬å…§å®¹ï¼š"
        unzip -l fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip
        echo ""
        echo "Firefox ç‰ˆæœ¬å…§å®¹ï¼š"
        unzip -l fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip

        # é¡¯ç¤ºå…©å€‹ç‰ˆæœ¬çš„ manifest å·®ç•°
        echo ""
        echo "Chrome manifest:"
        unzip -p fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip manifest.json | jq .
        echo ""
        echo "Firefox manifest:"
        unzip -p fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip manifest.json | jq .

    - name: Create Release using gh CLI
      run: |
        # ä½¿ç”¨ gh CLI å‰µå»º releaseï¼ˆè‰ç¨¿æ¨¡å¼ï¼Œè‡ªå‹•ç”¢ç”Ÿ release notesï¼‰
        gh release create ${{ steps.tag.outputs.tag_name }} \
          --title "FB Post URL Unhash ${{ steps.tag.outputs.tag_name }}" \
          --notes-file <(cat << 'EOF'
        ## FB Post URL Unhash - ${{ steps.tag.outputs.tag_name }}

        Facebook æ–‡ç« ç¶²å€è½‰æ›å™¨ - å°‡åŒ…å« pfbid çš„ Facebook æ–‡ç«  URL è½‰æ›æˆå¯æå–æ•¸å­— ID çš„æ ¼å¼ã€‚

        ### ğŸ“¦ å®‰è£æ–¹å¼
        1. æ ¹æ“šæ‚¨çš„ç€è¦½å™¨ä¸‹è¼‰å°æ‡‰çš„æª”æ¡ˆï¼š
           - **Chrome/Edge**: `fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip` (Manifest V3)
           - **Firefox**: `fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip` (Manifest V2)
        2. è§£å£“ç¸®åˆ°ä»»æ„ç›®éŒ„
        3. åœ¨ç€è¦½å™¨ä¸­è¼‰å…¥è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾ä½œç‚ºæ“´å……åŠŸèƒ½

        ### ğŸ¦Š Firefox å®‰è£ï¼š
        - å‰å¾€ `about:debugging`
        - é»æ“Šã€ŒThis Firefoxã€
        - é»æ“Šã€ŒLoad Temporary Add-onã€
        - é¸æ“‡è§£å£“ç¸®è³‡æ–™å¤¾ä¸­çš„ `manifest.json`

        ### ğŸ” Chrome/Edge å®‰è£ï¼š
        - å‰å¾€ `chrome://extensions/` æˆ– `edge://extensions/`
        - é–‹å•Ÿã€Œé–‹ç™¼äººå“¡æ¨¡å¼ã€
        - é»æ“Šã€Œè¼‰å…¥æœªå°è£é …ç›®ã€
        - é¸æ“‡è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾

        ### âœ¨ ä¸»è¦åŠŸèƒ½
        - âœ… è·¨ç€è¦½å™¨ç›¸å®¹ï¼ˆChromeã€Edgeã€Firefoxï¼‰
        - âœ… å½ˆå‡ºè¦–çª—ç›´æ¥é¡¯ç¤ºåµŒå…¥çš„ Facebook æ–‡ç« 
        - âœ… å³éµé¸å–®å¿«é€Ÿé–‹å•ŸåµŒå…¥é é¢
        - âœ… è‡ªå‹•åµæ¸¬ Facebook æ–‡ç«  URL æ ¼å¼

        EOF
        ) \
          --draft \
          --generate-notes \
          fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-chrome.zip \
          fb-post-url-unhash-${{ steps.tag.outputs.tag_name }}-firefox.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
